sequence:
  - variables:
      watch_notification_data: |-
        {% set notification = namespace(data={}) %}  
        {% set additional = namespace(data={}) %}  

        {% if title %}
          {% set notification.data = dict(notification.data, **{ 'title': title }) %}
        {% endif %}
        {% if message %}
          {% set notification.data = dict(notification.data, **{ 'message': message }) %}
        {% endif %}

        {% if tag %}
          {% set additional.data = dict(additional.data, **{ 'tag': tag }) %}
        {% endif %}
        {% if channel %}
          {% set additional.data = dict(additional.data, **{ 'channel': channel }) %}
        {% endif %}

        {% if notification_icon %}
          {% set additional.data = dict(additional.data, **{ 'notification_icon': notification_icon }) %}
        {% endif %}
        {% if notification_color %}
          {% set hex_color = '#%02x%02x%02x' | format(notification_color[0], notification_color[1], notification_color[2]) %}
          {% set additional.data = dict(additional.data, **{ 'color': hex_color }) %}
        {% endif %}
        {% if image_icon %}
          {% set additional.data = dict(additional.data, **{ 'icon_url': image_icon }) %}
        {% endif %}
        {% if additional.data %}
          {% set notification.data = dict(notification.data, **{ 'data': additional.data }) %}
        {% endif %}

        {{ notification.data }}
      mobile_notification_data: >-
        {% set notification = namespace(data={}) %}   
        {% set additional   = namespace(data={}) %}   {% set push = namespace(data={}) %}   
        {% set actions = [] %}

        {% if title %}
          {% set notification.data = dict(notification.data, **{ 'title': title }) %}
        {% endif %} 
        {% if message %}
          {% set notification.data = dict(notification.data, **{ 'message': message }) %}
        {% endif %}

        {% if notification_icon %}
          {% set additional.data = dict(additional.data, **{ 'notification_icon': notification_icon }) %}
        {% endif %} 
        {% if notification_color %}
          {% set hex_color = '#%02x%02x%02x' | format(notification_color[0], notification_color[1], notification_color[2]) %}
          {% set additional.data = dict(additional.data, **{ 'color': hex_color }) %}
        {% endif %} 
        {% if image_icon %}
          {% set additional.data = dict(additional.data, **{ 'icon_url': image_icon }) %}
        {% endif %} 
        {% if image %}
          {% set additional.data = dict(additional.data, **{ 'image': image }) %}
        {% endif %}


        {% if tag %}
          {% set additional.data = dict(additional.data, **{ 'tag': tag }) %}
        {% endif %} 
        {% if channel %}
          {% set additional.data = dict(additional.data, **{ 'channel': channel }) %}
        {% endif %} 
        {% if group %}
          {% set additional.data = dict(additional.data, **{ 'group': group }) %}
        {% endif %}

        {% if url_when_clicked %}
          {% set additional.data = dict(additional.data, **{ 'url': url_when_clicked }) %}
          {% set additional.data = dict(additional.data, **{ 'clickAction': url_when_clicked }) %}
        {% endif %}

        {% if sticky %}
          {% set additional.data = dict(additional.data, **{ 'sticky': sticky }) %}
        {% endif %} 
        {% if persistent %}
          {% set additional.data = dict(additional.data, **{ 'persistent': persistent }) %}
        {% endif %}

        {% if android_auto_ui %}
          {% set additional.data = dict(additional.data, **{ 'car_ui': android_auto_ui }) %}
        {% endif %}


        {% if timeout %}
          {% set additional.data = dict(additional.data, **{ 'timeout': timeout }) %}
        {% endif %}

        {% if progress %}
          {% set additional.data = dict(additional.data, **{ 'progress': progress }) %}
          {% set additional.data = dict(additional.data, **{ 'progress_max': progress_max | default(100) }) %}
        {% endif %} 
        {% if progress_indeterminate %}
          {% set additional.data = dict(additional.data, **{ 'progress': 1 }) %}
          {% set additional.data = dict(additional.data, **{ 'progress_indeterminate': progress_indeterminate }) %}
        {% endif %}

        {% if chronometer %}
          {% set additional.data = dict(additional.data, **{ 'chronometer': 'true' }) %}
          {% set additional.data = dict(additional.data, **{ 'when': chronometer }) %}
          {% set additional.data = dict(additional.data, **{ 'when_relative': 'false' if chronometer_relative == False else 'true' }) %}
        {% endif %}

        {% if enable_tts == true %}
          {% set notification.data = dict(notification.data, **{ 'message': "TTS" }) %}
          {% set additional.data = dict(additional.data, **{ 'tts_text': message }) %}
          {% set additional.data = dict(additional.data, **{ 'media_stream': media_stream | default("Default") }) %}
        {% elif clear_notification == true %}
          {% set notification.data = dict(notification.data, **{ 'message': "clear_notification" }) %}
        {% endif %}

        {% if interruption_level %} # iOS Only
          {% set push.data = dict(push.data, **{ 'interruption-level': interruption_level }) %}
        {% endif %}

        {% if sound %} # iOS Only
          {% set push.data = dict(push.data, **{ 'sound': sound }) %}
        {% endif %}


        {% if action_1_action or action_1_custom_action or action_1_title or action_1_uri %}
          {% set action = dict() %}
          {% if action_1_action or action_1_custom_action %}
            {% set action = dict(action, **{ 'action': action_1_custom_action if action_1_custom_action else action_1_action }) %}
          {% endif %}
          {% if action_1_title %}
            {% set action = dict(action, **{ 'title': action_1_title }) %}
          {% endif %}  
          {% if action_1_uri %}
            {% set action = dict(action, **{ 'uri': action_1_uri }) %}
          {% endif %}
          {% set actions = actions + [action] %}
        {% endif %}  
        {% if action_2_action or action_2_custom_action or action_2_title or action_2_uri %}
          {% set action = dict() %}
          {% if action_2_action or action_2_custom_action %}
            {% set action = dict(action, **{ 'action': action_2_custom_action if action_2_custom_action else action_2_action }) %}
          {% endif %}
          {% if action_2_title %}
            {% set action = dict(action, **{ 'title': action_2_title }) %}
          {% endif %}
          {% if action_2_uri %}
            {% set action = dict(action, **{ 'uri': action_2_uri }) %}
          {% endif %}
          {% set actions = actions + [action] %}
        {% endif %} 
        {% if action_3_action or action_3_custom_action or action_3_title or action_3_uri %}
          {% set action = dict() %}
          {% if action_3_action or action_3_custom_action %}
            {% set action = dict(action, **{ 'action': action_3_custom_action if action_3_custom_action else action_3_action }) %}
          {% endif %}
          {% if action_3_title %}
            {% set action = dict(action, **{ 'title': action_3_title }) %}
          {% endif %}
          {% if action_3_uri %}
            {% set action = dict(action, **{ 'uri': action_3_uri }) %}
          {% endif %}
          {% set actions = actions + [action] %}
        {% endif %} 
        {% if actions %}
          {% set additional.data = dict(additional.data, **{ 'actions': actions }) %}
        {% endif %}

        {% set additional.data = dict(additional.data, **{ 'priority': "high" }) %} 
        {% set additional.data = dict(additional.data, **{ 'ttl': 0 }) %}

        {% if command %}
          {% set additional.data = dict(additional.data, **{ 'command': message }) %}
          {% set notification.data = dict(notification.data, **{ 'message': command }) %}
        {% endif %} 
        {% if push.data %} # iOS Only
          {% set additional.data = dict(additional.data, **{ 'push': push.data }) %}
        {% endif %}

        {% if additional.data %}
          {% set notification.data = dict(notification.data, **{ 'data': additional.data }) %}
        {% endif %}

        {{ notification.data }}
  - alias: Repeat for all select Mobile Devices
    repeat:
      sequence:
        - data:
            message: "{{ message }}"
            title: "{{ title }}"
            push:
              interruption-level: "{{ interruption_level }}"
              sound: "{{ sound }}"
            data:
              url: |
                {{ url_when_clicked }}
              clickAction: |
                {{ url_when_clicked }}
              image: |
                {{ image | default(null) }}
              tag: |
                {{ tag }}
              group: |
                {{ group }}
              channel: |
                {{ channel }}
              priority: high
              ttl: 0
              sticky: |
                {{ sticky }}
              persistent: |
                {{ persistent }}
              notification_icon: "{{ notification_icon }}"
              color: >-
                #{{ '%02x%02x%02x' |
                format(notification_color[0],notification_color[1],notification_color[2])
                }}
              icon_url: "{{ image_icon }}"
              timeout: |
                {{ timeout }}
              progress: |
                {{ progress }}
              progress_max: |
                {{ progress_max }}
              progress_indeterminate: |
                {{ progress_indeterminate }}
              chronometer: |
                {{ 'true' if chronometer else 'false' }}
              when: |
                {{ chronometer }}
              when_relative: |
                {{ chronometer_relative }}
              actions:
                - action: "{{ action_1_action }}{{ action_1_custom_action}}"
                  title: "{{ action_1_title }}"
                  uri: "{{ action_1_uri }}"
                - action: "{{ action_2_action }}{{ action_2_custom_action}}"
                  title: "{{ action_2_title }}"
                  uri: "{{ action_2_uri }}"
                - action: "{{ action_3_action }}{{ action_3_custom_action}}"
                  title: "{{ action_3_title }}"
                  uri: "{{ action_3_uri }}"
          action: |
            notify.mobile_app_{{ device_attr(repeat.item, "name") | slugify}}
          enabled: false
          alias: Raw Example Notification (Using Variables)
        - alias: Phone vs Watch Notifications
          if:
            - alias: If NOT a watch
              condition: template
              value_template: >-
                {% set comment = "Notifications to WearOS don't seem to work
                properly if too many/the wrong parameters are sent" %}

                {% set comment = "This is what works for my TicWatch5 to
                separate it from a standard mobile notification" %}


                {% set MobileDeviceModel = device_attr(repeat.item, 'model') |
                lower %}

                {% if "watch" in MobileDeviceModel %}

                false

                {% else %}

                true 

                {% endif %}
          then:
            - data: "{{ mobile_notification_data }}"
              action: >
                notify.mobile_app_{{ device_attr(repeat.item, "name") |
                slugify}}
              alias: Phone Notification
          else:
            - data: "{{ watch_notification_data }}"
              action: >
                notify.mobile_app_{{ device_attr(repeat.item, "name") |
                slugify}}
              alias: Wear OS Notification
      for_each: "{{ phone_device_id }}"
alias: Dynamic Notify Mobile Device
fields:
  phone_device_id:
    selector:
      device:
        integration: mobile_app
        multiple: true
    name: Phone Device ID
    description: Mobile phone to notify
    required: true
    default: []
  notification_icon:
    selector:
      icon: {}
    name: Notification Icon
    description: Notification Status Bar Icon
    default: mdi:home-assistant
    required: false
  notification_color:
    selector:
      color_rgb: {}
    name: Notification Color
    description: Icon Color
    default:
      - 24
      - 188
      - 242
    required: false
  title:
    selector:
      text: null
    name: Title
    description: Notification Title ("Home Assistant" results in no title).
  message:
    selector:
      text:
        multiline: true
    name: Message
    required: false
    description: Notification Message
  enable_tts:
    selector:
      boolean: {}
    name: Enable TTS?
    description: >-
      If enabled, the Message will be played audibly using TTS (No visible notification will be sent to device) 
      [Will override "CLEAR NOTIFICATION"].
  media_stream:
    selector:
      select:
        options:
          - label: Music Volume (Default Volume ðŸ”‰)
            value: Default
          - label: Alarm Volume (Alarm Volume â°ðŸ”‰)
            value: alarm_stream
          - label: 100% Volume (MAX VOLUME ðŸ’¯ðŸ”ŠðŸ“¢)
            value: alarm_stream_max
    name: Media Stream (TTS Volume)
    description: >-
      Default = Music Volume 
      ------ 
      Alarm_Stream = Alarm Volumee 
      ------ 
      Max = 100% volume
    default: Default
  url_when_clicked:
    selector:
      text: null
    name: URL when Clicked
    description: >-
      For dashboards, use "/lovelace-mobile/cameras" for "http://homeassistant.loca:8123/lovelace-mobile/cameras"
    default: /lovelace-mobile/0
  image_icon:
    selector:
      text: null
    name: Image Icon
    description: >-
      Kind of like an Image, but shown when notification is folded. Use external URL or local relative path (i.e. /local/icon/icon.png).
    default: >-
      https://community-assets.home-assistant.io/optimized/3X/6/a/6a99ebb8d0b585a00b407123ff76964cb3e18780_2_500x500.png
  image:
    selector:
      text: null
    name: Image
    description: >-
      Must be a static img, GIFs do not work. External URL or local relative path (i.e. /local/icon/icon.png).
  channel:
    selector:
      select:
        options:
          - label: Default
            value: Default
          - label: ðŸ“· Security
            value: Security
          - label: ðŸš¶â€â™‚ï¸  Motion
            value: Motion
          - label: ðŸ§º Laundry
            value: Laundry
          - label: ðŸŒ¤  Weather
            value: Weather
          - label: ðŸ”” Reminder
            value: Reminder
          - label: ðŸš¨ alarm_stream ðŸš¨ (FULL VOLUME ALERT)
            value: alarm_stream
          - label: ðŸ§ª Test
            value: Test
    name: Channel
    description: >-
      "Categories". Easily allows settings different notification sounds, etc, based on notification type (Alarm vs Security vs Appliance notification) on Android [You can add more, these are just my defaults]
    required: false
  group:
    selector:
      text: null
    name: Group
    description: Combine notifications together visually if there's many.
  tag:
    selector:
      text: null
    name: Tag
    description: >-
      Unique Notification ID. Use to update a notification instead of sending multiple. Can also be used in case you want to dismiss the notification later with 'clear_notification'.
  clear_notification:
    selector:
      boolean: {}
    name: Clear Notification
    description: Dismiss the notification with the specified "Tag".
  sticky:
    selector:
      boolean: {}
    name: Sticky
    description: >-
      Sticky Notifications. Selecting it will not dismiss it. It must be swipped to be dismissed. 
  persistent:
    selector:
      boolean: {}
    name: Persistent
    description: >-
      Persistent Notification. CANNOT be swiped away. Must use tag. Use Dismiss + tag to clear. 
      (Can be dismissed by clicking. Use 'Sticky' to avoid this)
  notification_actions:
    selector:
      text:
        multiline: true
    name: Notification Actions
    default: |2
        - action: URI
          title: ðŸ“¸ Cameras
          uri: /lovelace-mobile/cameras
        - action: URI
          title: ðŸ”Š Ring
          uri: app://com.ringapp
          title: ðŸ“¸ Cameras
          uri: /lovelace-mobile/cameras


          - action: URI
            title: ðŸ”„ Backups
            uri: /hassio/backups
          - action: URI
            title: ðŸ  Blog
            uri: https://www.home-assistant.io/latest-release-notes/
          - action: URI
            title: â„¹ï¸ HA Info
            uri: /config/info
    description: "Define clickable actions. You can define up to 3 for Android. "
  action_1_action:
    selector:
      select:
        options:
          - label: >-
              URI     - Open app, HA dash, entity, system settings, etc (ie.
              uri: 'app://com.twitter.android')
            value: URI
          - label: OPEN    - Open a URL in a browser
            value: OPEN
          - label: REPLY   - (Allow user to send text as a reply)
            value: REPLY
          - label: "CALL   - Dial a number (ie. uri: 'tel:2125551212')"
            value: CALL
          - label: Alarm   - (Â¯\_(ãƒ„)_/Â¯ idk what it does)
            value: ALARM
          - label: Silence - (Â¯\_(ãƒ„)_/Â¯ idk what it does)
            value: SILENCE
    name: Action 1 action
  action_1_custom_action:
    selector:
      text: null
    name: "Action 1: Custom Action"
  action_1_title:
    selector:
      text: null
    name: Action 1 Title
  action_1_uri:
    selector:
      text: null
    name: Action 1 URI
  action_2_action:
    selector:
      select:
        options:
          - URI
          - ALARM
          - REPLY
          - SILENCE
          - CALL
          - OPEN
    name: Action 2 action
  action_2_custom_action:
    selector:
      text: null
    name: "Action 2: Custom Action"
  action_2_title:
    selector:
      text: null
    name: Action 2 Title
  action_2_uri:
    selector:
      text: null
    name: Action 2 URI
  action_3_action:
    selector:
      select:
        options:
          - URI
          - ALARM
          - REPLY
          - SILENCE
          - CALL
          - OPEN
    name: Action 3 action
  action_3_custom_action:
    selector:
      text: null
    name: "Action 3: Custom Action"
  action_3_title:
    selector:
      text: null
    name: Action 3 Title
  action_3_uri:
    selector:
      text: null
    name: Action 3 URI
  android_auto_ui:
    selector:
      boolean: {}
    name: Android Auto UI
    description: Whether or not the notification should show up in Android Auto
    required: true
    default: true
  command:
    selector:
      text: null
    name: Command
    description: >-
      For issuing commands, like opening Home Assistant to a specific page. Define the 'command' here, and any supporting data in "Message". 
      (IE. To open HA to a specific dashboard. Command="command_webview" and Message="lovelace-mobile/garage")
  subject:
    selector:
      text: null
    name: Subject
    description: A sub-title
  timeout:
    selector:
      number:
        min: 1
        max: 100000
        step: 1
    name: Timeout
    description: How long before the notification is automatically dismissed
  progress:
    selector:
      number:
        min: 1
        max: 100
        step: 1
    name: Progress
    description: Current value of the progress bar
  progress_max:
    selector:
      number:
        min: 10
        max: 100
        step: 1
    name: Progress Max
    description: Progress bar's 100% value (Defaults to 100 if not defined).
  progress_indeterminate:
    selector:
      boolean: {}
    name: Progress_indeterminate
    description: >-
      Overrides "Progress" bar, but "Progress" and "Progress Max" must still be set. Creates an animated "Loading"/"In Progress" progress bar
  chronometer:
    selector:
      number:
        min: 1
        max: 10000000
    name: Chronometer
    description: >-
      Real time count down. Value is in Seconds by default (unless Chronometer Relative is set to False).
  chronometer_relative:
    selector:
      boolean: {}
    name: Chronometer Relative
    description: "If true, value is in seconds. If false, value is in epoch time."
    default: false
  interruption_level:
    selector:
      select:
        options:
          - label: >-
              Passive - Quiet notifications without waking screen (Does not
              override Focus)
            value: passive
          - label: Active - Default behavior (Does not override Focus)
            value: active
          - label: Time-Sensitive - Important notifications (Overrides Focus)
            value: time-sensitive
          - label: Critical - Critical notifications (Overrides mute)
            value: critical
    name: interruption-level
    description: For iOS - Set Interruption Level
  sound:
    selector:
      text: null
    name: Sound
    description: >-
      For iOS - Set Notification sound (Use 'none' to disable notificationsound). 
      Refer to [Documentation](https://companion.home-assistant.io/docs/notifications/notification-sounds) for more info.
description: >-
  Notify a specific mobile device. Or Multiple!

  Has fields for nearly everything so you don't have to remember all that
  nonsense.  

  [Notification Documentation](https://companion.home-assistant.io/docs/notifications/actionable-notifications)
icon: mdi:cellphone-message
